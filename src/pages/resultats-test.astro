---
import BaseLayout from '../layouts/BaseLayout.astro';
import scoringRulesRaw from '../data/saat-scoring.json';
import mappingRaw from '../data/saat-mapping.json';
import pcaRulesRaw from '../data/saat-rules-pca.json';

// Pass scoring rules to client-side as JSON string
const scoringRulesJSON = JSON.stringify(scoringRulesRaw);

const breadcrumbItems = [
  { name: "Accueil", url: "/" },
  { name: "Test SAAT", url: "/test-saat" },
  { name: "Résultats", url: "#" }
];
---

<BaseLayout 
  title="Résultats SAAT™"
  description="Analyse du profil SAAT™."
  currentPage="resultats-test"
  breadcrumbItems={breadcrumbItems}
>

  <section class="results-section" style="padding: 4rem 0; background: #f8fafc; min-height: 80vh;">
    <div class="container">
      
      <!-- Loading state -->
      <div id="loadingState" style="text-align: center; padding: 6rem 2rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">⏳</div>
        <h2 style="color: #1e3a5f;">Chargement des résultats...</h2>
        <p style="color: #64748b;">Analyse en cours, veuillez patienter.</p>
      </div>

      <!-- Error state (hidden by default) -->
      <div id="errorState" style="display: none; text-align: center; padding: 6rem 2rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">⚠️</div>
        <h2 style="color: #dc2626;">Données introuvables</h2>
        <p style="color: #64748b;">Aucune donnée de test n'a été trouvée dans le lien. Le lien est peut-être invalide ou expiré.</p>
        <a href="/test-saat" style="display: inline-block; margin-top: 1.5rem; background: #1e3a5f; color: white; padding: 0.8rem 2rem; border-radius: 50px; text-decoration: none; font-weight: 600;">Passer le test SAAT™</a>
      </div>

      <!-- Results card (hidden by default, shown after JS processes data) -->
      <div id="resultsCard" style="display: none; background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); overflow: hidden; max-width: 900px; margin: 0 auto;">
        
        <!-- HEADER RAPPORT -->
        <div class="results-header" style="background: linear-gradient(135deg, #1e3a5f, #0d9488); padding: 2rem; color: white;">
          <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 1rem;">
            <div>
              <h1 style="font-size: 1.8rem; margin-bottom: 0.5rem;">Résultat Test Sigler's Ability Analysis</h1>
              <div style="opacity: 0.9;">Analyse de profil professionnel</div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 0.9rem; opacity: 0.8;">Test décrypté le :</div>
              <div id="reportDate" style="font-weight: bold; font-size: 1.1rem;"></div>
              <div id="reportId" style="font-size: 0.8rem; margin-top: 0.5rem; background: rgba(255,255,255,0.2); padding: 0.2rem 0.8rem; border-radius: 20px; display: inline-block;"></div>
            </div>
          </div>
        </div>

        <!-- INFO CANDIDAT -->
        <div class="candidate-info" style="padding: 2rem; border-bottom: 1px solid #e2e8f0; background: #fff;">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
            <div>
              <div style="color: #64748b; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;">Candidat</div>
              <div id="candidateName" style="font-size: 1.2rem; font-weight: 700; color: #1e3a5f;">—</div>
            </div>
            <div>
              <div style="color: #64748b; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;">Société</div>
              <div id="companyName" style="font-size: 1.1rem; color: #1e3a5f;">—</div>
            </div>
            <div>
              <div style="color: #64748b; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;">Poste visé</div>
              <div id="positionName" style="font-size: 1.1rem; color: #1e3a5f;">—</div>
            </div>
            <div>
              <div style="color: #64748b; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;">Expertise</div>
              <div id="expertiseType" style="font-size: 1.1rem; font-weight: 600; color: #0d9488;">—</div>
            </div>
          </div>
        </div>

        <div class="report-content" style="padding: 3rem 2rem;">
          
          <!-- GRAPHIQUE -->
          <h2 style="text-align: center; color: #1e3a5f; margin-bottom: 2rem;">RÉSULTAT TEST</h2>
          
          <div class="chart-container" style="position: relative; height: 400px; width: 100%; max-width: 700px; margin: 0 auto;">
            <canvas id="saatChart"></canvas>
          </div>

          <!-- TABLEAU DÉTAILS (CALCULÉ) -->
          <div style="margin-top: 4rem; display: grid; grid-template-columns: repeat(2, 1fr); gap: 2rem; max-width: 600px; margin-left: auto; margin-right: auto;">
            
            <div style="text-align: right; font-weight: 700; color: #1e3a5f; font-size: 1.1rem; display: flex; flex-direction: column; gap: 1rem;">
              <div>S : <span id="sec_S" style="color: #475569;">0/5</span></div>
              <div>PN : <span id="sec_PN" style="color: #475569;">0/12</span></div>
              <div>PP : <span id="sec_PP" style="color: #475569;">0/6</span></div>
              <div>V : <span id="sec_V" style="color: #475569;">0/9</span></div>
              <div>Co : <span id="sec_Co" style="color: #475569;">0/5</span></div>
              <div>R : <span id="sec_R" style="color: #475569;">0/12</span></div>
            </div>

            <div style="text-align: left; font-weight: 700; color: #1e3a5f; font-size: 1.1rem; display: flex; flex-direction: column; gap: 1rem;">
              <div>H/S : <span id="sec_H_S" style="color: #475569;">0/5</span></div>
              <div>N : <span id="sec_N" style="color: #475569;">0</span></div>
              <div>SO : <span id="sec_SO" style="color: #475569;">0/6</span></div>
              <div>O : <span id="sec_O" style="color: #475569;">0/7</span></div>
              <div>RA : <span id="sec_RA" style="color: #475569;">0/22</span></div>
              <div style="background: #f1f5f9; padding: 0.2rem 0.5rem; border-radius: 4px; border: 1px solid #cbd5e1;">Honnêteté : <span id="honestyIndex" style="color: #0d9488;">—</span></div>
            </div>

          </div>

          <div style="text-align: center; margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #e2e8f0;">
             <p style="color: #64748b; font-style: italic;">Ce document est une synthèse générée automatiquement.</p>
             <a href="/contact" class="cta-button" style="display: inline-block; margin-top: 1rem; background: #1e3a5f; color: white; padding: 0.8rem 2rem; border-radius: 50px; text-decoration: none; font-weight: 600;">Contacter un expert ABSIG</a>
          </div>

        </div>

      </div>

    </div>
  </section>

  <!-- CHARTS.JS via CDN -->
  <script is:inline src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- CLIENT-SIDE: Decode URL data, compute scores, render chart -->
  <script is:inline define:vars={{ rules: scoringRulesRaw, mapping: mappingRaw, pcaRules: pcaRulesRaw }}>
    document.addEventListener('DOMContentLoaded', function() {

      // --- 1. Read URL parameter ---
      const urlParams = new URLSearchParams(window.location.search);
      const dataParamV1 = urlParams.get('data');
      const dataParamV2 = urlParams.get('d');

      const loadingEl = document.getElementById('loadingState');
      const errorEl = document.getElementById('errorState');
      const resultsEl = document.getElementById('resultsCard');

      if (!dataParamV1 && !dataParamV2) {
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        return;
      }

      // --- 2. Decode Data (v1 or v2) ---
      let decoded = { profile: {}, answers: {} };
      const version = urlParams.get('v');

      try {
        if (version === '2') {
          // V2: Compact format (d=Base64PInfo.AnswersBitstring)
          const compactData = urlParams.get('d');
          if (!compactData) throw new Error("No V2 data");
          const [pEncoded, aCode] = compactData.split('.');
          
          // Decode Profile
          const pInfo = decodeURIComponent(atob(pEncoded)).split('|');
          decoded.profile = {
            fullName: pInfo[0] || 'Candidat',
            companyName: pInfo[1] || 'Non renseigné',
            function: pInfo[2] || 'Non renseigné'
          };
          
          // Decode Answers
          if (aCode) {
            for (let i = 0; i < aCode.length; i++) {
              const val = aCode[i];
              decoded.answers[i + 1] = (val === '2' ? 'OUI' : (val === '1' ? 'PLUS_OU_MOINS' : 'NON'));
            }
          }
          console.log('Données V2 décodées avec succès');
        } else {
          // V1: Legacy JSON Base64 format
          console.log('Tentative de décodage format V1...');
          const binaryString = atob(dataParamV1);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          const decodedString = new TextDecoder('utf-8').decode(bytes);
          decoded = JSON.parse(decodedString);
          console.log('Données V1 décodées avec succès');
        }
      } catch (e) {
        console.error('Erreur de décodage des données:', e);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        return;
      }

      // --- 3. Extract profile info ---
      const profileData = decoded.profile || {};
      const candidateName = profileData.fullName || "Candidat";
      const companyName = profileData.companyName || "Non renseigné";
      const positionName = profileData.function || "Non renseigné";

      // --- 4. Rules are passed directly via define:vars ---
      if (!rules || !Array.isArray(rules)) {
        console.error('Scoring rules manquantes ou invalides');
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        return;
      }

      // --- 5. Calculate scores ---
      const scores = { P: 0, C: 0, A: 0 };
      const secondary = { 
        S: { val: 0, max: 5 }, 
        H_S: { val: 0, max: 5 }, 
        PN: { val: 0, max: 12 }, 
        N: { val: 0, max: 0 },
        PP: { val: 0, max: 6 }, 
        SO: { val: 0, max: 6 },
        V: { val: 0, max: 9 }, 
        O: { val: 0, max: 7 },
        Co: { val: 0, max: 5 }, 
        RA: { val: 0, max: 22 },
        R: { val: 0, max: 12 }
      };

      const MULTIPLIER = 1; // Direct values from PCA rules
      const answers = decoded.answers || {};

      // We iterate over the mapping to apply rules for each form answer
      Object.keys(mapping).forEach(function(formIdx) {
        const baseId = mapping[formIdx];
        const answer = answers[formIdx];
        
        // 1. Calculate Secondary Stats using old scoringRules
        const rule = rules.find(r => r.id == baseId);
        if (rule && answer) {
          let impactSecondary = 0;
          if (answer === rule.target) impactSecondary = rule.impact;
          else if (answer === "PLUS_OU_MOINS") impactSecondary = rule.impact * 0.5;
          else if (answer && answer !== rule.target) impactSecondary = -rule.impact;

          var dimKey = rule.dimension === "H/S" ? "H_S" : rule.dimension;
          if (secondary[dimKey]) {
            if (impactSecondary > 0) secondary[dimKey].val += 1;
          }
        }

        // 2. Calculate P, C, A using PCA rules
        const pcaRule = pcaRules.find(r => r.id == formIdx); // PCA rules were built using formIdx in my extraction
        if (pcaRule && answer) {
          const valIdx = answer === "OUI" ? 0 : (answer === "PLUS_OU_MOINS" ? 1 : 2);
          if (pcaRule.p) scores.P += pcaRule.p[valIdx];
          if (pcaRule.c) scores.C += pcaRule.c[valIdx];
          if (pcaRule.a) scores.A += pcaRule.a[valIdx];
        }
      });

      // --- 5.1 Honesty Check ---
      let matchCount = 0;
      const checkPairs = [[2, 69], [7, 30], [8, 38, 62], [17, 56], [18, 24, 45]];
      checkPairs.forEach(group => {
        const vals = group.map(id => answers[id]);
        if (vals.every(v => v && v === vals[0])) matchCount++;
      });

      const honestyLevels = ["Instable", "Honnête", "Digne de confiance"];
      let honestyText = honestyLevels[Math.min(2, Math.floor(matchCount / 2))];
      if (matchCount === 0) honestyText = "Peu fiable";
      if (answers[3] === "OUI" || answers[34] === "OUI" || answers[49] === "OUI") honestyText += " (+Alerte)";

      // Clamp scores
      scores.P = Math.max(-200, Math.min(200, scores.P));
      scores.C = Math.max(-200, Math.min(200, scores.C));
      scores.A = Math.max(-200, Math.min(200, scores.A));

      // --- 6. Determine expertise ---
      let expertise = "Commercial";
      if (scores.P > 100) expertise = "Manager";
      else if (scores.A > 100) expertise = "Technique";

      // --- 7. Populate DOM ---
      document.getElementById('candidateName').textContent = candidateName;
      document.getElementById('companyName').textContent = companyName;
      document.getElementById('positionName').textContent = positionName;
      document.getElementById('expertiseType').textContent = expertise;
      document.getElementById('reportDate').textContent = new Date().toLocaleDateString('fr-FR');
      document.getElementById('reportId').textContent = 'ID: #' + Math.floor(Math.random() * 10000).toString().padStart(4, '0');

      // Secondary stats
      document.getElementById('sec_S').textContent = secondary.S.val + '/' + secondary.S.max;
      document.getElementById('sec_PN').textContent = secondary.PN.val + '/' + secondary.PN.max;
      document.getElementById('sec_PP').textContent = secondary.PP.val + '/' + secondary.PP.max;
      document.getElementById('sec_V').textContent = secondary.V.val + '/' + secondary.V.max;
      document.getElementById('sec_Co').textContent = secondary.Co.val + '/' + secondary.Co.max;
      document.getElementById('sec_R').textContent = secondary.R.val + '/' + secondary.R.max;
      document.getElementById('sec_H_S').textContent = secondary.H_S.val + '/' + secondary.H_S.max;
      document.getElementById('sec_N').textContent = secondary.N.val.toString();
      document.getElementById('sec_SO').textContent = secondary.SO.val + '/' + secondary.SO.max;
      document.getElementById('sec_O').textContent = secondary.O.val + '/' + secondary.O.max;
      document.getElementById('sec_RA').textContent = secondary.RA.val + '/' + secondary.RA.max;
      document.getElementById('honestyIndex').textContent = honestyText;

      // --- 8. Show results, hide loading ---
      loadingEl.style.display = 'none';
      resultsEl.style.display = 'block';
      
      // Refresh AOS to handle newly visible elements
      if (window.AOS) {
        window.AOS.refresh();
      }

      // --- 9. Render Chart ---
      const ctx = document.getElementById('saatChart');
      if (ctx) {
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Personnalité (P)', 'Communication (C)', 'Action (A)'],
            datasets: [{
              label: 'Score',
              data: [scores.P, scores.C, scores.A],
              backgroundColor: [
                'rgba(54, 162, 235, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(255, 99, 132, 0.8)'
              ],
              borderColor: [
                'rgb(54, 162, 235)',
                'rgb(75, 192, 192)',
                'rgb(255, 99, 132)'
              ],
              borderWidth: 1,
              barThickness: 60,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) { return context.raw; }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: false,
                min: -200,
                max: 200,
                grid: { color: 'rgba(0, 0, 0, 0.1)', lineWidth: 1 },
                ticks: { stepSize: 50 }
              },
              x: {
                grid: { display: false },
                ticks: { font: { size: 14, weight: 'bold' } }
              }
            },
            animation: {
              duration: 2000,
              easing: 'easeOutQuart'
            }
          }
        });
      }

    });
  </script>

</BaseLayout>
