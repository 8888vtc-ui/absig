---
const { currentLang = 'fr' } = Astro.props;

const t = {
  label: "Assistant",
  welcome: "Bonjour ! Je suis l'assistant ABSIG Consulting. Comment puis-je vous aider concernant vos besoins en recrutement ?",
  placeholder: "Posez votre question...",
  error: "Une erreur est survenue.",
  unavailable: "Service temporairement indisponible."
};

const phone = "06 82 26 73 42";
---

<div class="chatbot-container" id="chatbot-container" data-translations={JSON.stringify(t)}>
  <button 
    class="chatbot-toggle" 
    id="chatbot-toggle"
    aria-label={t.label}
    aria-expanded="false"
  >
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
    <span class="chatbot-label">{t.label}</span>
  </button>

  <div class="chatbot-window" id="chatbot-window" aria-hidden="true">
    <div class="chatbot-header">
      <h3 class="chatbot-title">ðŸ’¬ {t.label}</h3>
      <button class="chatbot-close" id="chatbot-close">âœ•</button>
    </div>
    
    <div class="chatbot-messages" id="chatbot-messages">
      <div class="chatbot-message chatbot-message-bot">
        <div class="message-content">
          <p>{t.welcome}</p>
        </div>
      </div>
    </div>
    
    <div class="chatbot-input-container">
      <form class="chatbot-form" id="chatbot-form">
        <input type="text" id="chatbot-input" class="chatbot-input" placeholder={t.placeholder} />
        <button type="submit" class="chatbot-send">âž¤</button>
      </form>
      <p class="chatbot-whatsapp-hint" style="font-size: 0.75rem; opacity: 0.7; margin-top: 8px;">
        Pour une rÃ©ponse immÃ©diate : <a href={`tel:${phone.replace(/\s/g, '')}`} style="font-weight: 600;">{phone}</a>
      </p>
    </div>
  </div>
</div>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const toggle = document.getElementById('chatbot-toggle');
    const chatWindow = document.getElementById('chatbot-window');
    const close = document.getElementById('chatbot-close');
    const form = document.getElementById('chatbot-form');
    const input = document.getElementById('chatbot-input');
    const messages = document.getElementById('chatbot-messages');

    const toggleChat = () => {
      chatWindow.classList.toggle('open');
      const isOpen = chatWindow.classList.contains('open');
      toggle.setAttribute('aria-expanded', isOpen);
      chatWindow.setAttribute('aria-hidden', !isOpen);
    };

    toggle.addEventListener('click', toggleChat);
    close.addEventListener('click', toggleChat);

    const responses = {
      default: "Merci pour votre message. Pour une rÃ©ponse personnalisÃ©e concernant votre projet de recrutement, nous vous invitons Ã  remplir notre formulaire de contact ou Ã  nous appeler directement au 06 82 26 73 42.",
      prix: "Nos honoraires sont calculÃ©s en fonction du profil recherchÃ© et du niveau de qualification. Contactez-nous pour recevoir un devis dÃ©taillÃ© et personnalisÃ©.",
      tarif: "Nos honoraires sont calculÃ©s en fonction du profil recherchÃ© et du niveau de qualification. Contactez-nous pour recevoir un devis dÃ©taillÃ© et personnalisÃ©.",
      garantie: "Nous offrons une garantie de remplacement d'un mois. Si le candidat ne convient pas durant la pÃ©riode d'essai, nous procÃ©dons Ã  un remplacement sans frais supplÃ©mentaires.",
      secteur: "Nous intervenons principalement dans trois secteurs : HÃ´tellerie & Restauration, BTP & Travaux Publics, et Informatique & Technologies.",
      visa: "Tous nos candidats sont citoyens de l'Union EuropÃ©enne. Aucune dÃ©marche de visa n'est nÃ©cessaire pour leur embauche en France.",
      delai: "Le dÃ©lai moyen de recrutement varie de 2 Ã  4 semaines selon le profil recherchÃ© et l'urgence de votre besoin.",
      candidat: "Nous disposons d'un rÃ©seau Ã©tendu de candidats qualifiÃ©s principalement issus de Bulgarie, Roumanie et d'autres pays de l'UE.",
    };

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const msg = input.value.trim();
      if(!msg) return;

      addMessage(msg, true);
      input.value = '';

      setTimeout(() => {
        let response = responses.default;
        const msgLower = msg.toLowerCase();
        
        for (const [key, value] of Object.entries(responses)) {
          if (key !== 'default' && msgLower.includes(key)) {
            response = value;
            break;
          }
        }
        
        addMessage(response, false);
      }, 600);
    });

    function addMessage(text, isUser) {
      const div = document.createElement('div');
      div.className = `chatbot-message ${isUser ? 'chatbot-message-user' : 'chatbot-message-bot'}`;
      div.innerHTML = `<div class="message-content"><p>${text}</p></div>`;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }
  });
</script>
