---
const { currentLang = 'fr' } = Astro.props;

const t = currentLang === 'en' ? {
  label: "Assistant",
  welcome: "Hello! I'm the ABSIG Consulting assistant. How can I help you with your recruitment needs?",
  placeholder: "Ask your question...",
  error: "An error occurred.",
  unavailable: "Service temporarily unavailable.",
  hint: "For an immediate response:"
} : {
  label: "Assistant",
  welcome: "Bonjour ! Je suis l'assistant ABSIG Consulting. Comment puis-je vous aider concernant vos besoins en recrutement ?",
  placeholder: "Posez votre question...",
  error: "Une erreur est survenue.",
  unavailable: "Service temporairement indisponible.",
  hint: "Pour une r√©ponse imm√©diate :"
};

const phone = "06 82 26 73 42";

// Chatbot auto-responses per language
const responsesEn = {
  default: "Thank you for your message. For a personalized response about your recruitment project, please fill out our contact form or call us directly at 06 82 26 73 42.",
  price: "Our fees are calculated based on the profile sought and the level of qualification. Contact us to receive a detailed, personalized quote.",
  cost: "Our fees are calculated based on the profile sought and the level of qualification. Contact us to receive a detailed, personalized quote.",
  guarantee: "We offer a one-month replacement guarantee. If the candidate doesn't work out during the trial period, we replace them at no extra cost.",
  sector: "We mainly operate in three sectors: Hospitality & Catering, Construction & Public Works, and IT & Technologies.",
  visa: "All our candidates are European Union citizens. No visa procedures are required for their employment in France.",
  delay: "The average recruitment timeline ranges from 2 to 4 weeks depending on the profile sought and the urgency of your need.",
  candidate: "We have an extensive network of qualified candidates mainly from Bulgaria, Romania, and other EU countries.",
  saat: "The SAAT‚Ñ¢ test is our exclusive assessment tool that analyzes 13 personality dimensions through 87 questions. It helps identify the ideal profile before the interview.",
  test: "The SAAT‚Ñ¢ test is our exclusive assessment tool. You can take it on our website: it takes about 15 minutes."
};

const responsesFr = {
  default: "Merci pour votre message. Pour une r√©ponse personnalis√©e concernant votre projet de recrutement, nous vous invitons √† remplir notre formulaire de contact ou √† nous appeler directement au 06 82 26 73 42.",
  prix: "Nos honoraires sont calcul√©s en fonction du profil recherch√© et du niveau de qualification. Contactez-nous pour recevoir un devis d√©taill√© et personnalis√©.",
  tarif: "Nos honoraires sont calcul√©s en fonction du profil recherch√© et du niveau de qualification. Contactez-nous pour recevoir un devis d√©taill√© et personnalis√©.",
  garantie: "Nous offrons une garantie de remplacement d'un mois. Si le candidat ne convient pas durant la p√©riode d'essai, nous proc√©dons √† un remplacement sans frais suppl√©mentaires.",
  secteur: "Nous intervenons principalement dans trois secteurs : H√¥tellerie & Restauration, BTP & Travaux Publics, et Informatique & Technologies.",
  visa: "Tous nos candidats sont citoyens de l'Union Europ√©enne. Aucune d√©marche de visa n'est n√©cessaire pour leur embauche en France.",
  delai: "Le d√©lai moyen de recrutement varie de 2 √† 4 semaines selon le profil recherch√© et l'urgence de votre besoin.",
  candidat: "Nous disposons d'un r√©seau √©tendu de candidats qualifi√©s principalement issus de Bulgarie, Roumanie et d'autres pays de l'UE.",
  saat: "Le test SAAT‚Ñ¢ est notre outil d'√©valuation exclusif qui analyse 13 dimensions de personnalit√© √† travers 87 questions. Il permet d'identifier le profil id√©al avant l'entretien.",
  test: "Le test SAAT‚Ñ¢ est disponible directement sur notre site. Il prend environ 15 minutes."
};

const chatResponses = currentLang === 'en' ? responsesEn : responsesFr;
---

<div class="chatbot-container" id="chatbot-container" data-translations={JSON.stringify(t)} data-responses={JSON.stringify(chatResponses)}>
  <button 
    class="chatbot-toggle" 
    id="chatbot-toggle"
    aria-label={t.label}
    aria-expanded="false"
  >
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
    </svg>
    <span class="chatbot-label">{t.label}</span>
  </button>

  <div class="chatbot-window" id="chatbot-window" aria-hidden="true">
    <div class="chatbot-header">
      <h3 class="chatbot-title">üí¨ {t.label}</h3>
      <button class="chatbot-close" id="chatbot-close">‚úï</button>
    </div>
    
    <div class="chatbot-messages" id="chatbot-messages">
      <div class="chatbot-message chatbot-message-bot">
        <div class="message-content">
          <p>{t.welcome}</p>
        </div>
      </div>
    </div>
    
    <div class="chatbot-input-container">
      <form class="chatbot-form" id="chatbot-form">
        <input type="text" id="chatbot-input" class="chatbot-input" placeholder={t.placeholder} />
        <button type="submit" class="chatbot-send">‚û§</button>
      </form>
      <p class="chatbot-whatsapp-hint" style="font-size: 0.75rem; opacity: 0.7; margin-top: 8px;">
        {t.hint} <a href={`tel:${phone.replace(/\s/g, '')}`} style="font-weight: 600;">{phone}</a>
      </p>
    </div>
  </div>
</div>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const toggle = document.getElementById('chatbot-toggle');
    const chatWindow = document.getElementById('chatbot-window');
    const close = document.getElementById('chatbot-close');
    const form = document.getElementById('chatbot-form');
    const input = document.getElementById('chatbot-input');
    const messages = document.getElementById('chatbot-messages');
    const container = document.getElementById('chatbot-container');

    const toggleChat = () => {
      chatWindow.classList.toggle('open');
      const isOpen = chatWindow.classList.contains('open');
      toggle.setAttribute('aria-expanded', isOpen);
      chatWindow.setAttribute('aria-hidden', !isOpen);
    };

    toggle.addEventListener('click', toggleChat);
    close.addEventListener('click', toggleChat);

    // Parse responses from data attribute
    let responses = {};
    try {
      responses = JSON.parse(container.dataset.responses || '{}');
    } catch(e) {}

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const msg = input.value.trim();
      if(!msg) return;

      addMessage(msg, true);
      input.value = '';

      setTimeout(() => {
        let response = responses.default || "Thank you for your message.";
        const msgLower = msg.toLowerCase();
        
        for (const [key, value] of Object.entries(responses)) {
          if (key !== 'default' && msgLower.includes(key)) {
            response = value;
            break;
          }
        }
        
        addMessage(response, false);
      }, 600);
    });

    function addMessage(text, isUser) {
      const div = document.createElement('div');
      div.className = `chatbot-message ${isUser ? 'chatbot-message-user' : 'chatbot-message-bot'}`;
      div.innerHTML = `<div class="message-content"><p>${text}</p></div>`;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }
  });
</script>
